<!doctype html>
<html lang="en">
    <head>
        <meta name="theme-color" content="#743EE4" />
        <link
            rel="icon"
            type="image/x-icon"
            href="data:text/svg;charset=utf-8;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+DQo8ZyBjbGlwLXBhdGg9InVybCgjY2xpcDBfMV8yKSI+DQo8cGF0aCBkPSJNMTkuNzA4NyA4OC42NTMzQzIwLjY0NCA4OC42NTMzIDIxLjM0NTUgODguMTY1OSAyMi40Mjk2IDg3LjE2OTZMMzIuMzU2NCA3OC4yNDY0SDUxLjg5MTVDNTkuNTg2MyA3OC4yNDY0IDYzLjg4MDIgNzMuODggNjMuODgwMiA2Ni4zMzQ1VjQ0LjcxNTFDNjMuODgwMiAzNy4xNDgzIDU5LjU4NjMgMzIuNzYwOCA1MS44OTE1IDMyLjc2MDhIMTUuOTg4OEM4LjI3MjYgMzIuNzYwOCA0IDM3LjEyNzEgNCA0NC43MTUxVjY2LjMzNDVDNCA3My45MjI1IDguMjcyNiA3OC4yNDY0IDE1Ljk4ODggNzguMjQ2NEgxNy41NjE4Vjg2LjE5NDdDMTcuNTYxOCA4Ny42Nzg0IDE4LjM0ODMgODguNjUzMyAxOS43MDg3IDg4LjY1MzNaIiBmaWxsPSIjNzQzRUU0IiBmaWxsLW9wYWNpdHk9IjAuODUiLz4NCjwvZz4NCjxnIGNsaXAtcGF0aD0idXJsKCNjbGlwMV8xXzIpIj4NCjxwYXRoIGQ9Ik03OC41MDQ5IDcwLjQ1MzNDNzkuODY1MyA3MC40NTMzIDgwLjY1MTcgNjkuNDc4NCA4MC42NTE3IDY3Ljk5NDdWNjAuMDQ2NEg4Mi4yMjQ4Qzg5LjkxOTYgNjAuMDQ2NCA5NC4yMTM2IDU1LjcyMjUgOTQuMjEzNiA0OC4xMzQ1VjI2LjUxNTFDOTQuMjEzNiAxOC45MjcxIDg5LjkxOTYgMTQuNTYwOCA4Mi4yMjQ4IDE0LjU2MDhINDYuMzIyMUMzOC42MDU5IDE0LjU2MDggMzQuMzMzMyAxOC45NDgzIDM0LjMzMzMgMjYuNTE1MVY0OC4xMzQ1QzM0LjMzMzMgNTUuNjggMzguNjA1OSA2MC4wNDY0IDQ2LjMyMjEgNjAuMDQ2NEg2NS44MzU5TDc1Ljc4NCA2OC45Njk2Qzc2Ljg2OCA2OS45NjU5IDc3LjU0ODIgNzAuNDUzMyA3OC41MDQ5IDcwLjQ1MzNaIiBmaWxsPSIjRjJDMTRCIiBmaWxsLW9wYWNpdHk9IjAuODUiLz4NCjwvZz4NCjxkZWZzPg0KPGNsaXBQYXRoIGlkPSJjbGlwMF8xXzIiPg0KPHJlY3Qgd2lkdGg9IjYwLjY2NjciIGhlaWdodD0iNTkuNDUzMyIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQgMjkuMikiLz4NCjwvY2xpcFBhdGg+DQo8Y2xpcFBhdGggaWQ9ImNsaXAxXzFfMiI+DQo8cmVjdCB3aWR0aD0iNjAuNjY2NyIgaGVpZ2h0PSI1OS40NTMzIiBmaWxsPSJ3aGl0ZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzQuMzMzMyAxMSkiLz4NCjwvY2xpcFBhdGg+DQo8L2RlZnM+DQo8L3N2Zz4="
        />
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Comic Chat: {{ room_name }}</title>
        <link
            href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
            rel="stylesheet"
        />

        <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.8.4"></script>
        <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.1/dist/socket.io.min.js"></script>
        <style>
            /* Comic book dot pattern background */
            .bg-comic-dots {
                background-image: radial-gradient(
                    #00000022 1px,
                    transparent 1px
                );
                background-size: 10px 10px;
            }
            /* Speech bubble tail */
            .bubble-tail-left::after {
                content: "";
                position: absolute;
                left: -10px;
                top: 50%;
                width: 0;
                height: 0;
                border: 10px solid transparent;
                border-right-color: inherit;
                border-left: 0;
                margin-top: -10px;
            }
            .bubble-tail-right::after {
                content: "";
                position: absolute;
                right: -10px;
                top: 50%;
                width: 0;
                height: 0;
                border: 10px solid transparent;
                border-left-color: inherit;
                border-right: 0;
                margin-top: -10px;
            }
            /* Custom scrollbar for comic feel */
            .comic-scrollbar::-webkit-scrollbar {
                width: 12px;
            }
            .comic-scrollbar::-webkit-scrollbar-track {
                background: #f5f3ff;
                border-radius: 10px;
            }
            .comic-scrollbar::-webkit-scrollbar-thumb {
                background: #c4b5fd;
                border-radius: 10px;
                border: 2px solid #f5f3ff;
            }

            /* Full screen layout */
            html,
            body {
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            .full-container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                width: 100%;
            }

            .chat-messages-container {
                flex: 1;
                overflow-y: auto;
            }
        </style>
    </head>
    <body class="bg-yellow-50 bg-comic-dots">
        <div
            id="chatPopup"
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50"
        >
            <div
                class="bg-purple-600 text-white p-6 shadow-lg border-4 border-purple-800 w-80 relative rounded-2xl"
            >
                <button
                    id="closePopup"
                    class="absolute top-2 right-2 text-white text-lg font-bold rounded-full"
                >
                    &times;
                </button>
                <h2 class="text-lg font-bold mb-4">
                    Join or Create a Chat Room
                </h2>

                <label for="chatRoomId" class="block mb-2"
                    >Enter Chat Room ID:</label
                >
                <input
                    type="text"
                    id="chatRoomId"
                    maxlength="6"
                    class="w-full p-2 text-black text-center uppercase tracking-widest border-2 border-purple-400 rounded-lg"
                />

                <button
                    id="joinChat"
                    class="bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold py-2 px-4 border-4 border-yellow-500 mt-4 w-full rounded-lg"
                >
                    Join Chat
                </button>

                <div class="border-t-2 border-white my-4"></div>

                <form method="POST" action="/create_room">
                    <button
                        type="submit"
                        id="newChat"
                        class="bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold py-2 px-4 border-4 border-yellow-500 w-full rounded-lg"
                    >
                        New Chat
                    </button>
                </form>
            </div>
        </div>

        <div class="full-container">
            <div
                class="bg-purple-600 text-white p-4 shadow-lg border-4 border-purple-800"
            >
                <div class="flex flex-wrap items-center justify-between">
                    <h1
                        class="text-3xl font-bold transform -rotate-1 inline-block bg-yellow-400 text-purple-900 px-4 py-1 shadow rounded-lg"
                    >
                        {{ room_name }}

                        <button
                            onclick="toggleChatPopup();"
                            class="ml-2 bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold py-2 px-4 border-4 border-yellow-500 transform rotate-1 transition-transform hover:rotate-0 rounded-lg"
                        >
                            âŒ˜
                        </button>
                    </h1>

                    <div class="flex items-center mt-2 md:mt-0">
                        <div class="block" id="loggedOut-main">
                            <button
                                onclick="loginButton();"
                                class="ml-2 bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold py-2 px-4 border-4 border-yellow-500 transform rotate-1 transition-transform hover:rotate-0 rounded-lg"
                            >
                                LOGIN!
                            </button>
                        </div>

                        <div class="hidden" id="loggedIn-main">
                            <button
                                onclick="loginoutButton();"
                                class="ml-2 bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold py-2 px-4 border-4 border-yellow-500 transform rotate-1 transition-transform hover:rotate-0 rounded-lg"
                            >
                                LOGOUT!
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div
                id="chat-container"
                class="bg-indigo-100 chat-messages-container overflow-y-auto p-4 border-l-4 border-r-4 border-purple-800 comic-scrollbar"
            >
                <div id="messages" class="space-y-4 pb-2">
                    <!-- Messages will be dynamically added here -->
                </div>
            </div>

            <div
                class="bg-purple-600 p-4 shadow-lg border-4 border-t-0 border-purple-800"
            >
                <div class="flex">
                    <input
                        id="message"
                        class="flex-grow p-4 border-4 border-purple-400 bg-white font-bold text-purple-800 placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-yellow-400 rounded-lg"
                        type="text"
                        placeholder="Type your message here!"
                        onkeydown="if(event.key === 'Enter'){ sendMessage(); }"
                    />
                    <button
                        onclick="sendMessage();"
                        class="ml-2 bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold py-2 px-6 border-4 border-yellow-500 transform rotate-1 transition-transform hover:rotate-0 rounded-lg"
                    >
                        SEND!
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Initialize the name variable
            let name = null;

            function toggleChatPopup() {
                document.getElementById("chatPopup").classList.toggle("hidden");
            }

            document
                .getElementById("closePopup")
                .addEventListener("click", toggleChatPopup);

            document
                .getElementById("joinChat")
                .addEventListener("click", function () {
                    const chatRoomId = document
                        .getElementById("chatRoomId")
                        .value.toUpperCase();
                    if (chatRoomId.length === 6) {
                        window.location.href = `/chat/${chatRoomId}`;
                    } else {
                        alert("Chat Room ID must be 6 characters long.");
                    }
                });

            function showLoggedInScreen() {
                document
                    .getElementById("loggedOut-main")
                    .classList.add("hidden");
                document
                    .getElementById("loggedIn-main")
                    .classList.remove("hidden");
            }

            function showLoggedOutScreen() {
                document
                    .getElementById("loggedOut-main")
                    .classList.remove("hidden");
                document
                    .getElementById("loggedIn-main")
                    .classList.add("hidden");
            }

            function deleteCookie(name) {
                document.cookie = name + "=; Max-Age=-99999999; path=/;";
            }

            function loginoutButton() {
                deleteCookie("session_cookie");
                deleteCookie("person_name");
                name = null;
                showLoggedOutScreen();

                // Notify others that user has left
                sayBye();

                // No need to reload, just update the UI
                // location.reload();
            }

            const baseUrl = window.location.origin;
            const fullUrl = `${baseUrl}/index.json`;

            function loginButton() {
                window.location.href = `http://login.rafemedia.com/login?scjson=${fullUrl}`;
            }
            // Available pastel colors for message bubbles
            const bubbleColors = [
                {
                    bg: "bg-pink-200",
                    border: "border-pink-400",
                    text: "text-pink-800",
                },
                {
                    bg: "bg-green-200",
                    border: "border-green-400",
                    text: "text-green-800",
                },
                {
                    bg: "bg-blue-200",
                    border: "border-blue-400",
                    text: "text-blue-800",
                },
                {
                    bg: "bg-yellow-200",
                    border: "border-yellow-400",
                    text: "text-yellow-800",
                },
                {
                    bg: "bg-indigo-200",
                    border: "border-indigo-400",
                    text: "text-indigo-800",
                },
                {
                    bg: "bg-red-200",
                    border: "border-red-400",
                    text: "text-red-800",
                },
                {
                    bg: "bg-purple-200",
                    border: "border-purple-400",
                    text: "text-purple-800",
                },
            ];

            function getCookie(name) {
                let cookieArr = document.cookie.split(";");
                for (let cookie of cookieArr) {
                    let [key, value] = cookie.trim().split("=");
                    if (key === name) return value;
                }
                return null;
            }

            // Username to color mapping to keep consistent colors
            const userColors = {};
            let colorIndex = 0;

            window.onload = function () {
                let cookieName = getCookie("person_name");

                if (cookieName !== null) {
                    name = cookieName;
                    showLoggedInScreen();
                    setTimeout(() => {
                        sayHi();
                        pastChat();
                    }, 500);
                } else {
                    showLoggedOutScreen();
                    pastChat();
                }

                // Scroll to the bottom of the chat
                setTimeout(scrollToBottom, 100);
            };

            window.addEventListener("beforeunload", function () {
                if (name !== null) {
                    sayBye();
                }
            });

            var socket = io.connect(
                "https://" + document.domain + ":" + location.port,
            );
            var room = "{{ room_name }}";
            socket.emit("join", room);

            socket.on("message", function (msg) {
                addMessage(msg);
                saveChat();
                scrollToBottom();
            });

            function getUserColor(username) {
                if (!userColors[username]) {
                    userColors[username] =
                        bubbleColors[colorIndex % bubbleColors.length];
                    colorIndex++;
                }
                return userColors[username];
            }

            function addMessage(msg) {
                const messagesDiv = document.getElementById("messages");
                // Parse message to get username and message content
                let username = "Anonymous";
                let messageContent = msg;
                const separatorIndex = msg.indexOf(" - ");
                if (separatorIndex > -1) {
                    username = msg.substring(0, separatorIndex);
                    messageContent = msg.substring(separatorIndex + 3);
                }
                // Get color for this user
                const color = getUserColor(username);
                // Determine if message is from current user
                const isCurrentUser = name !== null && username === name;
                // Create message element
                const messageDiv = document.createElement("div");
                messageDiv.className = isCurrentUser
                    ? "flex justify-end"
                    : "flex justify-start";
                // Create message bubble with comic style
                const bubble = document.createElement("div");
                bubble.className = `relative max-w-3/4 p-4 border-4 ${color.bg} ${color.border} ${color.text} font-bold transform ${isCurrentUser ? "bubble-tail-right" : "bubble-tail-left"}`;
                // For system messages (joins/leaves)
                if (
                    messageContent.includes("Joined The Chat") ||
                    messageContent.includes("Left The Chat") ||
                    messageContent.includes("Message too long!")
                ) {
                    bubble.className =
                        "relative max-w-3/4 p-3 border-4 bg-gray-200 border-gray-400 text-gray-800 font-bold transform rotate-0";
                }

                // Add username
                const usernameSpan = document.createElement("span");
                usernameSpan.className =
                    "block font-extrabold uppercase text-xs";
                usernameSpan.textContent = username;
                bubble.appendChild(usernameSpan);

                // Process message content
                let processedContent = messageContent;

                // Handle image embeds
                const imgRegex = /IMG-"(https?:\/\/\S+?)"/g;
                let imgMatch;
                let imgElements = [];

                while ((imgMatch = imgRegex.exec(messageContent)) !== null) {
                    const imageUrl = imgMatch[1];
                    processedContent = processedContent.replace(
                        imgMatch[0],
                        "",
                    );

                    // Create image element to add later
                    const imgElement = document.createElement("img");
                    imgElement.src = imageUrl;
                    imgElement.className = "max-w-full mt-2 rounded";
                    imgElement.alt = "Embedded image";
                    imgElements.push(imgElement);
                }

                // Handle iframe embeds
                const iframeRegex = /WEB-"(https?:\/\/\S+?)"/g;
                let iframeMatch;
                let iframeElements = [];

                while (
                    (iframeMatch = iframeRegex.exec(messageContent)) !== null
                ) {
                    const iframeUrl = iframeMatch[1];
                    processedContent = processedContent.replace(
                        iframeMatch[0],
                        "",
                    );

                    // Create iframe element to add later
                    const iframeElement = document.createElement("iframe");
                    iframeElement.src = iframeUrl;
                    iframeElement.className = "w-full mt-2 border-0 rounded";
                    iframeElement.style.height = "300px";
                    iframeElement.setAttribute("allowfullscreen", "true");
                    iframeElement.setAttribute("loading", "lazy");
                    iframeElements.push(iframeElement);
                }

                // Add the text content (without the embed commands)
                const textSpan = document.createElement("span");
                textSpan.textContent = processedContent.trim();
                bubble.appendChild(textSpan);

                // Add all image elements
                imgElements.forEach((img) => {
                    bubble.appendChild(img);
                });

                // Add all iframe elements
                iframeElements.forEach((iframe) => {
                    bubble.appendChild(iframe);
                });

                messageDiv.appendChild(bubble);
                messagesDiv.appendChild(messageDiv);
            }

            let canSendMessage = true; // Throttle flag

            function sendMessage() {
                if (!canSendMessage) return; // Prevent sending if throttled

                const messageInput = document.getElementById("message");
                let messageContent = messageInput.value.trim();

                if (!messageContent) {
                    return; // Don't send empty messages
                }

                const maxLength = name ? 400 : 200;

                if (messageContent.length > maxLength) {
                    let userperson = name || "Anonymous"; // Assign directly using logical OR

                    socket.send(
                        `ADMIN - Message too long! ${userperson} Max allowed: ${maxLength} characters.`,
                        room,
                    );

                    return;
                }

                // Send message with name if logged in, otherwise send normally
                if (name) {
                    let messages = name + " - " + messageContent;
                    socket.send(messages, room);
                } else {
                    socket.send(messageContent, room);
                }

                messageInput.value = "";
                messageInput.focus();

                // Throttle sending (1 message per 3 seconds)
                canSendMessage = false;
                setTimeout(() => {
                    canSendMessage = true;
                }, 2000); // 3 seconds cooldown
            }

            function pastChat() {
                var roomid = "{{ room_name }}";
                var storedMessages = localStorage.getItem(roomid);

                if (storedMessages) {
                    document.getElementById("messages").innerHTML =
                        storedMessages;
                    scrollToBottom();
                }
            }

            function saveChat() {
                var divElement = document.getElementById("messages");
                var messageContent = divElement.innerHTML;
                var roomid = "{{ room_name }}";

                try {
                    localStorage.setItem(roomid, messageContent);
                } catch (e) {
                    // If localStorage is full, clear some old messages
                    if (e.code === 22 || e.name === "QuotaExceededError") {
                        // Keep only the most recent messages
                        var messagesDiv = document.getElementById("messages");
                        var messageElements = messagesDiv.children;

                        // Remove oldest messages if there are more than 50
                        while (messageElements.length > 50) {
                            messagesDiv.removeChild(messageElements[0]);
                        }

                        // Try saving again
                        localStorage.setItem(roomid, messagesDiv.innerHTML);
                    }
                }
            }

            function sayHi() {
                if (name) {
                    let messages = name + " - Has Joined The Chat";
                    socket.send(messages, room);
                }
            }

            function sayBye() {
                if (name) {
                    let messages = name + " - Has Left The Chat";
                    socket.send(messages, room);
                }
            }

            function scrollToBottom() {
                const chatContainer = document.getElementById("chat-container");
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function getCookie(name) {
                let cookieArr = document.cookie.split(";");
                for (let cookie of cookieArr) {
                    let [key, value] = cookie.trim().split("=");
                    if (key === name) return value;
                }
                return null;
            }

            function getUrlParameter(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }

            const cookie = getUrlParameter("cookie");
            const personname = getUrlParameter("personname");
            if (cookie) {
                document.cookie = `session_cookie=${cookie}; path=/`;
                document.cookie = `person_name=${personname}; path=/`;
                window.location.href = "/";
            } else if (getCookie("session_cookie")) {
                // Show the logged-in screen if session_cookie exists
                showLoggedInScreen();
            }

            function showLoggedInScreen() {
                document
                    .getElementById("loggedOut-main")
                    .classList.add("hidden");
                document
                    .getElementById("loggedIn-main")
                    .classList.remove("hidden");
                personcookieValue = getCookie("person_name");
            }
        </script>
    </body>
</html>
