<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Comic Chat: {{ room_name }}</title>
        <link
            href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
            rel="stylesheet"
        />

        <script>
            if (window.location.protocol === "https:") {
                window.location.protocol = "http:";
            }
        </script>

        <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.8.4"></script>
        <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.1/dist/socket.io.min.js"></script>
        <style>
            /* Comic book dot pattern background */
            .bg-comic-dots {
                background-image: radial-gradient(
                    #00000022 1px,
                    transparent 1px
                );
                background-size: 10px 10px;
            }
            /* Speech bubble tail */
            .bubble-tail-left::after {
                content: "";
                position: absolute;
                left: -10px;
                top: 50%;
                width: 0;
                height: 0;
                border: 10px solid transparent;
                border-right-color: inherit;
                border-left: 0;
                margin-top: -10px;
            }
            .bubble-tail-right::after {
                content: "";
                position: absolute;
                right: -10px;
                top: 50%;
                width: 0;
                height: 0;
                border: 10px solid transparent;
                border-left-color: inherit;
                border-right: 0;
                margin-top: -10px;
            }
            /* Custom scrollbar for comic feel */
            .comic-scrollbar::-webkit-scrollbar {
                width: 12px;
            }
            .comic-scrollbar::-webkit-scrollbar-track {
                background: #f5f3ff;
                border-radius: 10px;
            }
            .comic-scrollbar::-webkit-scrollbar-thumb {
                background: #c4b5fd;
                border-radius: 10px;
                border: 2px solid #f5f3ff;
            }
        </style>
    </head>
    <body class="bg-yellow-50 bg-comic-dots min-h-screen">
        <div class="container mx-auto p-4 max-w-4xl">
            <!-- Header with comic book style -->
            <div
                class="bg-purple-600 text-white p-4 rounded-t-lg shadow-lg border-4 border-purple-800"
            >
                <div class="flex flex-wrap items-center justify-between">
                    <h1
                        class="text-3xl font-bold transform -rotate-1 inline-block bg-yellow-400 text-purple-900 px-4 py-1 rounded shadow"
                    >
                        {{ room_name }}
                    </h1>

                    <div class="flex items-center mt-2 md:mt-0">
                        <input
                            id="name"
                            class="p-2 border-4 border-purple-400 rounded bg-white font-bold text-purple-800 placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-yellow-400 transform rotate-1"
                            type="text"
                            placeholder="YOUR NAME HERE!"
                            onkeydown="if(event.key === 'Enter'){ setName(); }"
                        />
                        <button
                            onclick="setName();"
                            class="ml-2 bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold py-2 px-4 rounded-lg border-4 border-yellow-500 transform rotate-1 transition-transform hover:rotate-0"
                        >
                            SET!
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages container with fixed height and scrolling -->
            <div
                id="chat-container"
                class="bg-indigo-100 h-96 overflow-y-auto p-4 border-l-4 border-r-4 border-purple-800 comic-scrollbar"
            >
                <div id="messages" class="space-y-4 pb-2">
                    <!-- Messages will be dynamically added here -->
                </div>
            </div>

            <!-- Message input area -->
            <div
                class="bg-purple-600 p-4 rounded-b-lg shadow-lg border-4 border-t-0 border-purple-800"
            >
                <div class="flex">
                    <input
                        id="message"
                        class="flex-grow p-4 border-4 border-purple-400 rounded-lg bg-white font-bold text-purple-800 placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        type="text"
                        placeholder="Type your message here!"
                        onkeydown="if(event.key === 'Enter'){ sendMessage(); }"
                    />
                    <button
                        onclick="sendMessage();"
                        class="ml-2 bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold py-2 px-6 rounded-lg border-4 border-yellow-500 transform rotate-1 transition-transform hover:rotate-0"
                    >
                        SEND!
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Available pastel colors for message bubbles
            const bubbleColors = [
                {
                    bg: "bg-pink-200",
                    border: "border-pink-400",
                    text: "text-pink-800",
                },
                {
                    bg: "bg-green-200",
                    border: "border-green-400",
                    text: "text-green-800",
                },
                {
                    bg: "bg-blue-200",
                    border: "border-blue-400",
                    text: "text-blue-800",
                },
                {
                    bg: "bg-yellow-200",
                    border: "border-yellow-400",
                    text: "text-yellow-800",
                },
                {
                    bg: "bg-indigo-200",
                    border: "border-indigo-400",
                    text: "text-indigo-800",
                },
                {
                    bg: "bg-red-200",
                    border: "border-red-400",
                    text: "text-red-800",
                },
                {
                    bg: "bg-purple-200",
                    border: "border-purple-400",
                    text: "text-purple-800",
                },
            ];

            // Username to color mapping to keep consistent colors
            const userColors = {};
            let colorIndex = 0;

            window.onload = function () {
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const name = urlParams.get("name");

                if (name !== null) {
                    document.getElementById("name").value = name;
                    setTimeout(() => {
                        sayHi();
                        pastChat();
                    }, 500);
                }

                // Scroll to the bottom of the chat
                setTimeout(scrollToBottom, 100);
            };

            window.addEventListener("beforeunload", function () {
                sayBye();
            });

            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const name = urlParams.get("name");

            var socket = io.connect(
                "http://" + document.domain + ":" + location.port,
            );
            var room = "{{ room_name }}";
            socket.emit("join", room);

            socket.on("message", function (msg) {
                addMessage(msg);
                saveChat();
                scrollToBottom();
            });

            function getUserColor(username) {
                if (!userColors[username]) {
                    userColors[username] =
                        bubbleColors[colorIndex % bubbleColors.length];
                    colorIndex++;
                }
                return userColors[username];
            }

            function addMessage(msg) {
                const messagesDiv = document.getElementById("messages");

                // Parse message to get username and message content
                let username = "Anonymous";
                let messageContent = msg;

                const separatorIndex = msg.indexOf(" - ");
                if (separatorIndex > -1) {
                    username = msg.substring(0, separatorIndex);
                    messageContent = msg.substring(separatorIndex + 3);
                }

                // Get color for this user
                const color = getUserColor(username);

                // Determine if message is from current user
                const isCurrentUser = name !== null && username === name;

                // Create message element
                const messageDiv = document.createElement("div");
                messageDiv.className = isCurrentUser
                    ? "flex justify-end"
                    : "flex justify-start";

                // Create message bubble with comic style
                const bubble = document.createElement("div");
                bubble.className = `relative max-w-3/4 p-4 rounded-lg border-4 ${color.bg} ${color.border} ${color.text} font-bold transform ${isCurrentUser ? "-rotate-1 bubble-tail-right" : "rotate-1 bubble-tail-left"}`;

                // For system messages (joins/leaves)
                if (
                    messageContent.includes("Joined The Chat") ||
                    messageContent.includes("Left The Chat")
                ) {
                    bubble.className =
                        "relative max-w-3/4 p-3 rounded-lg border-4 bg-gray-200 border-gray-400 text-gray-800 font-bold transform rotate-0";
                }

                // Add username and message
                const usernameSpan = document.createElement("span");
                usernameSpan.className =
                    "block font-extrabold uppercase text-xs";
                usernameSpan.textContent = username;

                const messageSpan = document.createElement("span");
                messageSpan.textContent = messageContent;

                bubble.appendChild(usernameSpan);
                bubble.appendChild(messageSpan);
                messageDiv.appendChild(bubble);
                messagesDiv.appendChild(messageDiv);
            }

            function sendMessage() {
                if (name !== null) {
                    var ume = document.getElementById("message").value;
                    let messages = name.concat(" - ", ume);
                    if (ume) {
                        socket.send(messages, room);
                        document.getElementById("message").value = "";
                    }
                } else {
                    var nonamemessage =
                        document.getElementById("message").value;
                    if (nonamemessage) {
                        socket.send(nonamemessage, room);
                        document.getElementById("message").value = "";
                    }
                }
            }

            function setName() {
                var gname = document.getElementById("name").value;
                if (gname.trim() !== "") {
                    let url = new URL(window.location.href);
                    url.searchParams.set("name", gname);
                    window.history.replaceState(null, "", url);
                    location.reload();
                }
            }

            function pastChat() {
                var roomid = "{{ room_name }}";
                var storedMessages = localStorage.getItem(roomid);

                if (storedMessages) {
                    document.getElementById("messages").innerHTML =
                        storedMessages;
                }
            }

            function saveChat() {
                var divElement = document.getElementById("messages");
                var messageContent = divElement.innerHTML;
                var roomid = "{{ room_name }}";

                try {
                    localStorage.setItem(roomid, messageContent);
                } catch (e) {
                    // If localStorage is full, clear some old messages
                    if (e.code === 22 || e.name === "QuotaExceededError") {
                        // Keep only the most recent messages
                        var messagesDiv = document.getElementById("messages");
                        var messageElements = messagesDiv.children;

                        // Remove oldest messages if there are more than 50
                        while (messageElements.length > 50) {
                            messagesDiv.removeChild(messageElements[0]);
                        }

                        // Try saving again
                        localStorage.setItem(roomid, messagesDiv.innerHTML);
                    }
                }
            }

            function sayHi() {
                var ume = "Has Joined The Chat";
                let messages = name.concat(" - ", ume);
                if (ume) {
                    socket.send(messages, room);
                }
            }

            function sayBye() {
                var ume = "Has Left The Chat"; // Fixed the typo
                let messages = name.concat(" - ", ume);
                if (ume && name) {
                    socket.send(messages, room);
                }
            }

            function scrollToBottom() {
                const chatContainer = document.getElementById("chat-container");
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        </script>
    </body>
</html>
